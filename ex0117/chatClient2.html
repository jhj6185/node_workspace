<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <h3>채팅 클라이언트</h3>
    <br>
    <div>
        <input type="text" id="hostInput" value="localhost"/>
        <input type="text" id="portInput" value="3000"/>
        <input type="button" id="connectButton" value="연결하기"/>
    </div><br>
    <!-- 일대일 채팅을 위한 영역 -->
    <div>
        <input type="text" id="userIdInput" value="test01">
        <input type="password" id="userPwdInput" value="1234">
        <input type="text" id="aliasInput" value="코난">
        <input type="text" id="todayInput" value="쨍!">
        <input type="button" id="loginButton" value="로그인">
        <input type="button" id="logoutButton" value="로그아웃">
    </div>

    <div>
        <span>보내는 사람 아이디 : </span>
        <input type="text" id="senderInput" value="test01">
    </div>
    <div>
        <span>받는 사람 아이디 : </span>
        <input type="text" id="recepientInput" value="ALL">
    </div>
    <div>
        <span>메시지 데이터 : </span>
        <input type="text" id="dataInput" value="안녕!">
    </div><br>
    <input type="button" id="sendButton" value="전송"/>
    <hr/>
    <p>결과 : </p>
    <div id="result"></div>
</body>
<script src="/socket.io/socket.io.js"></script>
<!-- 이거는 socketio npm install 해서 깐 것을 불러내는거라 무조건 이 경로임 -->
<script>
    var host;
    var port;
    var socket;
    $(function(){
        //문서 로딩 후 실행됨
        $("#connectButton").bind('click', function(event){
            println('connectButton이 클릭됨');
            host = $('#hostInput').val(); //localhost
            port = $('#portInput').val(); //3000
            connectToServer();
        });
    });
    function connectToServer(){
        //서버에 연결하는 함수 정의
        var options= {'forceNew': true}; // 기존의 연결을 재사용 할 수 있도록
        var url = 'http://'+host+':'+port;
        socket = io.connect(url,options);
        socket.on('connect', function(){ //연결됐을때
            println('웹소켓 서버에 연결됨 : '+url);
            socket.on('message', function(message){ //message를 받으면
                console.log(JSON.stringify(message));
                println('<p>수신 메시지 : '+message.sender + ','+message.recepient+','+message.command+','+
                    message.data+'</p>');
            });
            socket.on('response', function(response){
                console.log(JSON.stringify(response));
                println('<p>응답 메시지를 받았습니다 : '+response.command+','+response.code+
                    response.message+'</p>');
            });
        });
        socket.on('disconnect',function(){ //종료됐을 때
            println('웹소켓 연결이 종료됨');
        });
    }
    function println(data){ //#result에 계속 쓸 수 있도록 println함수를 따로뺌
        console.log(data);
        $('#result').append('<p>'+data+'</p>');
    }

    //전송 버튼 클릭시 처리
    $("#sendButton").bind('click', function(event){
        var sender = $('#senderInput').val();
        var recepient = $('#recepientInput').val();
        console.log(recepient + " : recepient 머임?")
        var data = $('#dataInput').val();
        var output = { 
            sender: sender,
            recepient : recepient,
            command : 'chat',
            type: 'text',
            data : data
        };
        console.log('서버로 보낼 데이터 : '+JSON.stringify(output));
        if(socket == undefined){
            alert('서버에 연결되어 있지 않음, 먼저 서버에 연결 바람');
            return;
        }
        socket.emit('message', output); // 5,6 은 오타없음
    });

    //로그인 버튼 클릭시 처리
    $("#loginButton").bind('click', function(event){
        var userId = $('#userIdInput').val();
        var userPwd = $('#userPwdInput').val();
        var alias = $('#aliasInput').val();
        var today = $('#todayInput').val();
        var output = {userId : userId, userPwd : userPwd, alias : alias, today : today};
        console.log('서버로 보낼 데이터 : '+JSON.stringify(output));
        if(socket == undefined){
            alert('서버에 연결 안됨, 먼저 서버에 연결부터');
            return;
        }
        socket.emit('login', output);
    })
</script>
</html>
<!-- 모든 사람한테 보내는것 : emit, 받는것 on -->
<!-- 특정한 사람한테 보내는 건 emit아님 -->